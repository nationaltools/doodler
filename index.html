<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<link rel="stylesheet" type="text/css" href="style.css" />
<META name="description" content="Doodler is a tool that helps you practice your drawing / painting skills.">
<META name="keywords" content="drawing, draw, practice, paint, doodle, doodler, flickr, quick, training, references">
<link rel="chrome-webstore-item" href="https://chrome.google.com/webstore/detail/kkibgipamepglokkgajhiholokhcjmog">
<link rel="icon" type="image/png" href="icon.png" />
<link href='https://fonts.googleapis.com/css?family=Oxygen:300' rel='stylesheet' type='text/css'>
<title>Doodler</title>

<script src="lib.js"></script>
<script type="text/javascript">
"use strict";

var UI = {};

UI.showPopup = (function () {
	var popDiv;
	return function (p) {
		var close;
		var closed = false;
		if (!popDiv) {
			popDiv = document.createElement("div");
			LIB.css(popDiv, {
				position: "fixed",
				left: "0",
				top: "0",
				width: "100%",
				height: "100%",
				opacity: 0,
				transition: "opacity 0.3s linear"
			});
			popDiv.bgDiv = document.createElement("div");
			LIB.css(popDiv.bgDiv, {
				position: "absolute",
				left: "0",
				top: "0",
				width: "100%",
				height: "100%",
				background: "rgba(0, 0, 0, 0.5)"
			});
			popDiv.appendChild(popDiv.bgDiv);
		}
		function updateHeight() {
			if(closed) {
				return;
			}
			LIB.css(popDiv, {
				height: "100%"
			});
			setTimeout(updateHeight, 100);
		}
		updateHeight();
		//popDiv.contentWrapper.innerHTML = "";
		popDiv.appendChild(p.div);
		LIB.css(p.div, {
			width: (7 * 22 * 2) + "px",
			marginLeft: "auto",
			marginRight: "auto",
			position: "relative"
		});
		popDiv.ontouchmove = function() {
			return false;
		};
		p.target.appendChild(popDiv);
		setTimeout(function () {
			LIB.css(popDiv, {
				opacity: 1
			});
		}, 20);
		close = function () {
			if(closed) {
				return;
			}
			closed = true;
			LIB.css(popDiv, {
				opacity: 0
			});
			setTimeout(function () {
				p.target.removeChild(popDiv);
				popDiv.removeChild(p.div);
				if(p.callback) {
					p.callback();
				}
				//popDiv.contentWrapper.innerHTML = "";
			}, 300);
		};
		popDiv.bgDiv.onclick = function() {
			close();
			return false;
		};
		p.setCallback(close);
	};
}());
//callback - time runs out
//how long time inbetween?
var CountdownTimer = function(p) {
	var div = document.createElement("div");
	var limit = Math.max(1, p.limit);
	var countdown = limit;
	var paused = p.paused;
	div.id = "timerBox";
	
	var canvas = document.createElement("canvas");
	canvas.width = 80;
	canvas.height = 80;
	canvas.style.width = "80px";
	canvas.style.marginLeft = "10px";
	var context = canvas.getContext("2d");
	
	var timeOut = document.createElement("div");
	timeOut.style.textAlign = "center";
	timeOut.style.marginTop = "-7px";
	timeOut.style.fontFamily = "arial";
	timeOut.style.textShadow = "0 1px 0 #666";
	timeOut.style.color = "#fff";
	
	
	div.appendChild(canvas);
	div.appendChild(timeOut);
	
	var transition = false;
	var transCount = 0;
	
	function update() {
		canvas.width = canvas.width;
		context.save();
		context.fillStyle = "rgba(0,0,0,0.1)";
		context.shadowColor = 'rgba(0,0,0,0.3)';
		context.shadowBlur = 4;
		context.shadowOffsetX = 1;
		context.shadowOffsetY = 2;
		context.beginPath();
		context.translate(canvas.width / 2, canvas.height / 2);
		context.arc(0, 0, canvas.width / 5 * 2, 0, 2 * Math.PI, false);
		context.closePath();
		context.fill();
		context.restore();
		if(paused) {
			setTimeout(update, 100);
			return;
		}
		if(countdown <= 0) {
			countdown = limit;
			//transition = true;
			transCount = 100;
			p.callback();
		}
		
		if(transCount > 0) {
			context.save();
			context.globalAlpha = (1 - transCount / 100);
			context.fillStyle = "rgba(220, 220, 220,1)";
			context.shadowColor = 'rgba(0,0,0,0.2)';
			context.shadowBlur = 2;
			context.shadowOffsetX = 1;
			context.shadowOffsetY = 2;
			context.beginPath();
			context.translate(canvas.width / 2, canvas.height / 2);
			context.rotate(-Math.PI / 2);
			context.scale(1 - Math.pow(transCount / 100, 4), 1 - Math.pow(transCount / 100, 4));
			context.moveTo(0, 0);
			context.arc(0, 0, canvas.width / 5 * 2, 0, -2 * Math.PI * countdown / limit, true);
			context.closePath();
			context.fill();
			context.restore();
			
			var refillCount = (1 - transCount / 100) * limit;
			var minutes = refillCount / 60 - ((refillCount / 60) % 1);
			var seconds = "" + (refillCount % 60 - (refillCount % 1));
			if (refillCount % 60 < 10) {
				seconds = "0" + seconds;
			}
			//if(countdown < 10) {
			//	timeOut.innerHTML = "<b>" + minutes + ":" + seconds + "</b>";
			//} else {
				timeOut.innerHTML = minutes + ":" + seconds;
			//}
			//timeOut.innerHTML = "";
			
			
			transCount -= 3;
			setTimeout(update, 16);
		} else {
			
			context.save();
			context.fillStyle = "rgba(220, 220, 220,1)";
			context.shadowColor = 'rgba(0,0,0,0.2)';
			context.shadowBlur = 2;
			context.shadowOffsetX = 1;
			context.shadowOffsetY = 2;
			context.beginPath();
			context.translate(canvas.width / 2, canvas.height / 2);
			context.rotate(-Math.PI / 2);
			context.moveTo(0, 0);
			context.arc(0, 0, canvas.width / 5 * 2, 0, -2 * Math.PI * countdown / limit, true);
			context.closePath();
			context.fill();
			context.restore();
			
			var minutes = countdown / 60 - ((countdown / 60) % 1);
			var seconds = "" + (countdown % 60 - (countdown % 1));
			if (countdown % 60 < 10) {
				seconds = "0" + seconds;
			}
			if(countdown < 10) {
				timeOut.innerHTML = "<b>" + minutes + ":" + seconds + "</b>";
			} else {
				timeOut.innerHTML = minutes + ":" + seconds;
			}
			
			countdown -= 0.1;
			setTimeout(update, 100);
		}
		
	}
	update();
	
	
	//when skipping
	this.reset = function() {
		countdown = limit;
	};
	this.pause = function(p) {
		if(p !== paused) {
			paused = p;
		}
	};
	this.setTime = function(p) {
		
	};
	this.setTimelimit = function(timelimit) {
		limit = timelimit;
	};
	this.getDiv = function(p) {
		return div;
	};
};

UI.ColorSlider = function(p) {
	var div = document.createElement("div");
	var value = p.initVal;
	LIB.css(div, {
		width: "160px",
		height: "40px",
		position: "absolute",
		left: "300px",
		marginLeft: "-80px",
		top: "10px",
		borderRadius: "20px",
		textAlign: "center",
		lineHeight: "110px",
		cursor: "default",
		backgroundImage: "-webkit-linear-gradient(left, rgb(0,0,0) 12.5%, rgb(255,255,255) 87.5%)",
		boxShadow: "inset 0 4px 7px 1px rgba(0,0,0,0.5)",
		color: "#ccc"
	});
	div.className = "brushColorSlider";
	div.onmousedown = function() {
		return false;
	};
	div.innerHTML = "Color";
	var ball = document.createElement("div");
	LIB.css(ball, {
		width: "32px",
		height: "32px",
		//backgroundColor: "#aaa",
		borderRadius: "20px",
		position: "absolute",
		left: "4px",
		top: "4px",
		boxShadow: "0 0 1px 2px rgba(255,255,255,0.5), inset 0 0 1px 2px rgba(0,0,0,0.5)"
	});
	div.appendChild(ball);
	var inputArea = document.createElement("div");
	LIB.css(inputArea, {
		width: "160px",
		height: "40px",
		position: "absolute",
		left: 0,
		top: 0,
		cursor: "pointer"
	});
	div.appendChild(inputArea);
	
	function update() {
		var area = 160 - 40;
		var outval = value;
		LIB.css(ball, {
			left: (4+ outval * area) + "px"//,
			//backgroundColor: "rgb(" + parseInt(outval * 255, 10) + ", " + parseInt(outval * 255, 10) + ", " + parseInt(outval * 255, 10) + ")"
		});
	}
	update();
	p.callback(value);
	LIB.attachMouseListener(inputArea, function(val) {
		if(val.dragdone === false && val.code === 0) {
			value = Math.max(0, Math.min(1, val.x / (160 - 40) * (160) - (20 / 160)));
			p.callback(value);
			update()
		}
	});
	this.setValue = function(p) {
		value = p;
		update();
	};
	this.getDiv = function(p) {
		return div;
	};
};

UI.Slider = function(p) {
	var div = document.createElement("div");
	var value = p.initVal;
	LIB.css(div, {
		width: "160px",
		height: "40px",
		position: "absolute",
		left: "100px",
		marginLeft: "-80px",
		top: "10px",
		backgroundColor: "#444",
		borderRadius: "20px",
		textAlign: "center",
		lineHeight: "110px",
		cursor: "default",
		boxShadow: "inset 0 4px 7px 1px rgba(0,0,0,0.5)",
		color: "#ccc"
	});
	div.onmousedown = function() {
		return false;
	};
	div.innerHTML = "Brush Size";
	var ball = document.createElement("div");
	LIB.css(ball, {
		width: "32px",
		height: "32px",
		backgroundColor: "#aaa",
		borderRadius: "20px",
		position: "absolute",
		left: "4px",
		top: "4px"
	});
	div.appendChild(ball);
	var inputArea = document.createElement("div");
	LIB.css(inputArea, {
		width: "160px",
		height: "40px",
		position: "absolute",
		left: 0,
		top: 0,
		cursor: "pointer"
	});
	div.appendChild(inputArea);
	
	
	function update() {
		var area = 160 - 40;
		var outval = Math.max(0, Math.min(1, value / (160 - 40) * (160) - (20 / 160)));
		LIB.css(ball, {
			left: (4+ outval * area) + "px"
		});
	}
	update();
	p.callback(value);
	LIB.attachMouseListener(inputArea, function(val) {
		if(val.dragdone === false && val.code === 0) {
			value = val.x;
			p.callback(Math.max(0, Math.min(1, value / (160 - 40) * (160) - (20 / 160))));
			update();
		}
	});
	
	this.getDiv = function(p) {
		return div;
	};
};

var PracticeHistory = function(p) {
	var div = document.createElement("div");
	
	this.add = function(p) {
	};
	this.getDiv = function(p) {
		return div;
	};
};

function requestFlickrImages(callback) {
	var result = [];
	var handleResponse = function(response) {
		response = response.replace("jsonFlickrApi(", "");
		response = response.substring(0, response.length-1);
		response = JSON.parse(response);
		
		var ims = response.photos.photo;
		var im;
		for(var i = 0; i < ims.length; i++) {
			im = ims[i];
			result[i] = {};
			result[i].imSrc = 'http://farm' + im.farm + '.static.flickr.com/' + im.server + '/' + im.id + '_' + im.secret + '.jpg';
			result[i].link = 'http://www.flickr.com/photo.gne?id=' + im.id;
			result[i].title = im.title;
			result[i].owner = im.ownername;
		}
		var randomResult = [];
		var pos;
		while(result.length > 0) {
			var pos = parseInt(Math.min(result.length - 1, Math.random() * result.length));
			randomResult.push(result[pos]);
			result.splice(pos, 1)
		}
		callback(randomResult);
	};
	var req = new XMLHttpRequest();
	req.open('GET', 'imrequest.php', true);
	req.onreadystatechange = function (aEvt) {
	  if (req.readyState == 4) {
		  handleResponse(req.responseText);
	  }
	};
	req.send(null);
}

var CanvasInputArea = function(p) {
	var div = document.createElement("div");
	var drawing = false;
	var picking = false;
	var altPressed = false;
	div.oncontextmenu = function() {
		return false;
	};
	LIB.attachMouseListener(div, function(val) {
		if(val.pinch) {
			return;
		}
		var x = val.absX;
		var y = val.absY;
		if(altPressed) {
			if((val.down || val.dragdone === false) && val.code === 0) {
				p.callback( {
					pick: true,
					x: x,
					y: y
				});
			} else {
				p.callback( {
					pick: true
				});
			}
		} else if(val.down || val.dragdone !== undefined) {
			if(val.down && val.code === 0) {
				drawing = true;
				p.callback( {
					down: true,
					dragdone: false,
					x: x,
					y: y
				});
			}
			if(val.dragdone === false && drawing) {
				p.callback( {
					dragdone: false,
					x: x,
					y: y
				});
			}
			if(val.dragdone && drawing) {
				drawing = false;
				p.callback( {
					up: true
				});
			}
			if(val.down && val.code === 2) {
				picking = true;
				p.callback( {
					pick: true,
					x: x,
					y: y
				});
			}
			if(val.dragdone === false && picking) {
				p.callback( {
					pick: true,
					x: x,
					y: y
				});
			}
			if(val.dragdone && picking) {
				picking = false;
			}
		} else if(val.move){
			p.callback( {
				move: true,
				x: x,
				y: y
			});
		} else if(val.out){
			p.callback( {
				out: true
			});
		}
	});
	this.altPressed = function(p) {
		altPressed = p;
	};
	this.getDiv = function() {
		return div;
	};
};

UI.BarButton = function(p) {
	var div = document.createElement("div");
	div.className = "barButton";
	div.innerHTML = p.label;
	LIB.css(div, p.style);
	if(p.title){
		div.title = p.title;
	}
	
	function click() {
		p.callback();
	}
	div.onclick = function() {
		click();
	};
	div.onmousedown = function() {
		return false;
	};
	/*div.ontouchstart = function (event) {
		if (event.touches.length > 1) {
			return;
		}
		click();
	};*/
	
	
	
	this.getDiv = function() {
		return div;
	};
};

UI.PickerButton = function(p) {
	var div = document.createElement("div");
	div.className = "pickerButton";
	var state = false;
	LIB.css(div, p.style);
	if(p.title){
		div.title = p.title;
	}
	
	function click() {
		state = !state;
		update();
		p.callback();
	}
	div.onclick = function() {
		click();
	};
	div.onmousedown = function() {
		return false;
	};

	
	function update() {
		if(state) {
			LIB.css(div, {
				boxShadow: "0 0 10px 5px rgba(255,255,255,1)",
				backgroundColor: "#444"
			});
		} else{
			LIB.css(div, {
				boxShadow: "",
				backgroundColor: ""
			});
		}
	}
	this.getState = function(p) {
		return state;
	};
	this.setState = function(p) {
		state = p;
		update();
	};
	this.getDiv = function() {
		return div;
	};
};

UI.RefOutput = function(p) {
	var div = document.createElement("div");
	var ims = [];
	var initDone = false;
	div.id = "ref";
	var nowDat;
	var bgSize = "cover";
	
	var preloadedIm;
	div.innerHTML = '<br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><center><img src="loading.gif"/><br/><span style="color:#000">Loading...</span></center>';
	function handleRequestCallback(val) {
		ims = ims.concat(val);
		if(!initDone) {
			div.innerHTML = "";
			showNextImage();
		}
	}
	function showNextImage() {
		if(!preloadedIm) {
			
			preloadedIm = document.createElement("div");
			preloadedIm.className = "refWrapper";
			preloadedIm.style.backgroundImage = "url(" + ims[0].imSrc + ")";
			div.appendChild(preloadedIm);
			initDone = true;
			p.callback({
				initDone: true
			});
			nowDat = ims.shift();
		} else {
			preloadedIm.className = "refWrapper";
			setTimeout(function() {
				div.removeChild(div.firstChild);
			}, 510);
			nowDat = ims.shift();
		}
		preloadedIm.style.backgroundSize = bgSize;
		var thisStyle = preloadedIm.style;
		preloadedIm.onclick = function() {
			if(bgSize === "cover") {
				bgSize = "auto";
			} else {
				bgSize = "cover";
			}
			thisStyle.backgroundSize = bgSize;
			preloadedIm.style.backgroundSize = bgSize;
		};
		if(ims[0]) {
			preloadedIm = document.createElement("div");
			preloadedIm.class = "refWrapperLoading";
			preloadedIm.style.backgroundImage = "url(" + ims[0].imSrc + ")";
			div.appendChild(preloadedIm);
		}
		if(ims.length < 3) {
			requestFlickrImages(handleRequestCallback);
		}
	}
	requestFlickrImages(handleRequestCallback);
	
	this.nextImage = function() {
		var result = nowDat;
		showNextImage();
		return result;
	};
	this.getDiv = function() {
		return div;
	};
};

UI.CanvasOverlay = function(p) {
	var div = document.createElement("div");
	var brushSize = p.brushSize;
	var brushColor = p.brushColor;
	var show = false;
	var previewTimeout;
	var ignoreInitial = true;
	setTimeout(function() {
		ignoreInitial = false;
	}, 200);
	LIB.css(div, {
		width: "500px",
		height: "500px",
		position: "absolute",
		left: "0px",
		top: "40px",
		overflow: "hidden"
	});
	var cursorDiv = document.createElement("div");
	LIB.css(cursorDiv, {
		width: (brushSize * 2) + "px",
		height: (brushSize * 2) + "px",
		pointerEvents: "none",
		backgroundColor: "rgba(" + brushColor.r + ", " + brushColor.g + ", " + brushColor.b + ", 0.8)",
		position: "absolute",
		borderRadius: (brushSize) + "px",
		display: "none"
	});
	div.appendChild(cursorDiv);
	
	this.hide = function() {
		if(show) {
			show = false;
		}
		cursorDiv.style.display = "none";
	};
	this.updatePos = function(p) {
		if(previewTimeout) {
			clearTimeout(previewTimeout);
		}
		if(!show) {
			show = true;
			LIB.css(cursorDiv, {
				display: "block"
			});
		}
		LIB.css(cursorDiv, {
			left: (p.x - brushSize) + "px",
			top: (p.y - brushSize) + "px"
		});
	};
	this.setBrushSize = function(p) {
		
		brushSize = p;
		if(ignoreInitial){
			LIB.css(cursorDiv, {
				borderRadius: (brushSize) + "px",
				width: (brushSize * 2) + "px",
				height: (brushSize * 2) + "px",
				left: (250 - brushSize) + "px",
				top: (250 - brushSize) + "px"
			});
		} else {
			LIB.css(cursorDiv, {
				borderRadius: (brushSize) + "px",
				width: (brushSize * 2) + "px",
				height: (brushSize * 2) + "px",
				left: (250 - brushSize) + "px",
				top: (250 - brushSize) + "px",
				display: "block"
			});
		}
		if(previewTimeout) {
			clearTimeout(previewTimeout);
		}
		previewTimeout = setTimeout(function() {
			LIB.css(cursorDiv, {
				display: "none"
			});
		}, 200);
		/*if(!show) {
			LIB.css(cursorDiv, {
				width: (brushSize * 2) + "px",
				height: (brushSize * 2) + "px",
				pointerEvents: "none",
				backgroundColor: "rgba(" + brushColor.r + ", " + brushColor.g + ", " + brushColor.b + ", 0.8)",
				position: "absolute",
				borderRadius: (brushSize) + "px"
			});
		}*/
	};
	this.setBrushColor = function(p) {
		brushColor = p;
		LIB.css(cursorDiv, {
			backgroundColor: "rgba(" + brushColor.r + ", " + brushColor.g + ", " + brushColor.b + ", 0.8)"
		});
		
	};
	this.showPreview = function() {
	};
	this.getDiv = function() {
		return div;
	};
};

UI.DrawingTools = function(p) {
	var div = document.createElement("div");
	var CURSOR_CROSSHAIR = 0;
	var CURSOR_PICKER = 2;
	var cursor = CURSOR_CROSSHAIR;
	var cursorPickerIm;
	var changed = false;
	var pickCanvas = document.createElement("canvas");
	pickCanvas.width = 1;
	pickCanvas.height = 1;
	
	LIB.css(div, {
		position: "absolute",
		left: 0,
		top: 0
	});
	
	
	
	var canvasLabel = document.createElement("div");
	LIB.css(canvasLabel, {
		position: "absolute",
		left: "0px",
		top: "10px",
		width: "500px",
		textAlign: "center",
		color: "#999"
	});
	canvasLabel.innerHTML = "Right-click or alt+click to pick color from canvas.";
	div.appendChild(canvasLabel);
	
	
	
	
	
	LIB.loadImageToDataURL({
		src: "cursor_picker.png",
		callback: function (p) {
			cursorPickerIm = p;
		}
	});
	function setCursor(c) {
		if (c === cursor) {
			return;
		}
		cursor = c;
		if (cursor === CURSOR_CROSSHAIR) {
			canvasInputArea.getDiv().style.cursor = "crosshair";
		}
		if (cursor === CURSOR_PICKER && cursorPickerIm) {
			canvasInputArea.getDiv().style.cursor = "url(" + cursorPickerIm + ") 0 15, pointer";
		}
	}
	
	var keys = {
		KEY_Z: 90,
		KEY_CTRL: 17,
		KEY_ALT: 18,
		KEY_SPACE: 32,
		ctrlPressed: false,
		altPressed: false,
		spacePressed: false
	};
	function onKeys(val) {
		var unicode;
		unicode = val.keyCode || val.charCode;
		if (val.down) {
			if (unicode === keys.KEY_SPACE) {
				//keys.spacePressed = true;
				//setCursor(CURSOR_HAND);
			}
			if (unicode === keys.KEY_CTRL) {
				//keys.ctrlPressed = true;
			}
			if (unicode === keys.KEY_ALT) {
				keys.altPressed = true;
				canvasInputArea.altPressed(true);
				setCursor(CURSOR_PICKER);
				canvasOverlay.hide();
			}
			if (unicode === keys.KEY_Z && keys.ctrlPressed) {
				//val.preventDefault();
				//callback({
				//	undo: true
				//});
			}
		} else if (val.up) {
			if (unicode === keys.KEY_SPACE) {
				//keys.spacePressed = false;
				//setCursor(CURSOR_CROSSHAIR);
			}
			if (unicode === keys.KEY_CTRL) {
				//keys.ctrlPressed = false;
			}
			if (unicode === keys.KEY_ALT) {
				keys.altPressed = false;
				canvasInputArea.altPressed(false);
				setCursor(CURSOR_CROSSHAIR);
			}
		}
	}
	document.addEventListener("keydown", function (val) {
		val.down = true;
		onKeys(val);
	});
	document.addEventListener("keyup", function (val) {
		val.up = true;
		onKeys(val);
	});
	window.addEventListener("blur", function () {
		keys.spacePressed = false;
		keys.altPressed = false;
		keys.ctrlPressed = false;
		canvasInputArea.altPressed(false);
	});
	
	
	var pickerButton = new UI.PickerButton({
		title: "Eyedropper",
		callback: function() {
		}
	});
	
	
	
	
	//Canvas
	var canvasWrapper;
	var canvas = document.createElement("canvas");
	LIB.css(canvas, {
		position: "absolute",
		left: "0px",
		top: "40px",
		boxShadow: "3px 10px 25px rgba(0,0,0,0.4)"
	});
	canvas.width = 500;
	canvas.height = 500;
	var context = canvas.getContext("2d");
	context.fillStyle = "rgba(255, 255, 255, 1)";
	context.fillRect(0, 0, canvas.width, canvas.height);
	var canvasOverlay = new UI.CanvasOverlay({
		brushSize: 10,
		brushColor: {r:0, g: 0, b: 0}
	});
	var brushCursor;
	var inputArea;
	var pickTip;
	
	var brush = new LIB.Brush();
	brush.setContext(context);
	
	var canvasInputArea = new CanvasInputArea({
		callback: function(p) {
			var off = LIB.getGlobalOff(canvasInputArea.getDiv());
			if(p.pick || pickerButton.getState()) {
				setCursor(CURSOR_PICKER);
				canvasOverlay.hide();
				brush.endLine();
				if(pickerButton.getState() && !p.pick) {
					if(p.dragdone === false) {
						pickCanvas.width = 1;
						pickCanvas.getContext("2d").drawImage(canvas, -(p.x- 100), -(p.y - 40));
						var data = pickCanvas.getContext("2d").getImageData(0, 0, 1, 1).data;
						brush.setColor({r: data[0], g: data[1], b: data[2]});
						canvasOverlay.setBrushColor({r: data[0], g: data[1], b: data[2]});
						colorSlider.setValue(data[0] / 255);
					}
					if(p.up) {
						pickerButton.setState(false);
					}
				} else if(p.x !== undefined) {
					pickCanvas.width = 1;
					pickCanvas.getContext("2d").drawImage(canvas, -(p.x- 100), -(p.y - 40));
					var data = pickCanvas.getContext("2d").getImageData(0, 0, 1, 1).data;
					brush.setColor({r: data[0], g: data[1], b: data[2]});
					canvasOverlay.setBrushColor({r: data[0], g: data[1], b: data[2]});
					colorSlider.setValue(data[0] / 255);
					pickerButton.setState(false);
					
				}
			} else if(!keys.altPressed) {
				setCursor(CURSOR_CROSSHAIR);
			}
			if(!pickerButton.getState()) {
				if(p.down) {
					canvasOverlay.hide();
					brush.startLine(p.x- 100, p.y - 40, 1);
					changed = true;
				} else if(p.dragdone === false) {
					brush.goLine(p.x- 100, p.y - 40, 1);
				} else if(p.up) {
					brush.endLine();
				} else if (p.move) {
					canvasOverlay.updatePos({
						x: p.x - 100,
						y: p.y - 40
					});
				} else if(p.out) {
					canvasOverlay.hide();
				}
			}
		}
	});
	LIB.css(canvasInputArea.getDiv(), {
		position: "absolute",
		left: "-100px",
		top: 0,
		height: "600px",
		width: "640px",
		cursor: "crosshair",
		background: "rgba(0,0,0,0)"
	});
	div.appendChild(canvas);
	div.appendChild(canvasOverlay.getDiv());
	div.appendChild(canvasInputArea.getDiv());
	brush.setOpacity(0.2);
	//settings
	var toolBar = document.createElement("div");
	toolBar.id = "brushTools";
	var sizeSlider = new UI.Slider( {
		initVal: 0.25,
		callback: function(val) {
			var size = Math.max(2, val* 50);
			canvasOverlay.setBrushSize(size);
			brush.setSize(size);
			
		}
	});
	toolBar.appendChild(sizeSlider.getDiv());
	var colorSlider = new UI.ColorSlider( {
		initVal: 0,
		callback: function(val) {
			var color = parseInt(val* 255);
			brush.setColor({r: color, g: color, b: color});
			canvasOverlay.setBrushColor({r: color, g: color, b: color});
		}
	});
	toolBar.appendChild(colorSlider.getDiv());
	brush.setSpacing(0.2);
	div.appendChild(toolBar);
	div.appendChild(pickerButton.getDiv());
	
	this.next = function() {
		var result;
		if(changed) {
			result = canvas.toDataURL('image/png');
			context.fillStyle = "rgba(255, 255, 255, 1)";
			context.fillRect(0, 0, canvas.width, canvas.height);
		}
		changed = false;
		return result;
	};
	this.getDiv = function() {
		return div;
	};
};

/*
	callback -> refDrawingPair
*/
UI.DrawingScreen = function(p) {
	var callback = p.callback;
	var contentDiv = document.createElement("div");
	var barDiv = document.createElement("div");
	barDiv.style.height = "100%";
	var paused = true;
	var ims = [];
	var mode = "time120";
	var initDone = false;
	var timelimit = 2;
	
	var transition = false;
	
	var lefty = getCookie("lefty");
	if(lefty == ""){
		lefty = false;
	}
	if(lefty == "true") {
		lefty = true;
	}
	if(lefty == "false") {
		lefty = false;
	}
	
	
	//Ref
	var refOutput = new UI.RefOutput({
		callback: function(val) {
			if(val.initDone) {
				initDone = true;
				if(!paused) {
					timer.pause(false);
				}
			}
		}
	});
	contentDiv.appendChild(refOutput.getDiv());
	
	function showNextImage() {
		var refDrawingPair = {};
		refDrawingPair.ref = refOutput.nextImage();
		refDrawingPair.drawing = drawingTools.next();
		if(refDrawingPair.drawing) {
			callback({
				nextImage: true,
				data: refDrawingPair
			});
		}
	}
	
	//Tools
	var drawingTools = new UI.DrawingTools({
	});
	contentDiv.appendChild(drawingTools.getDiv());
	
	//Bar
	var barWrapper = document.createElement("div");
	barWrapper.id = "barCenterContainer";
	var stopButton = new UI.BarButton( {
		label: "Stop",
		style: {
			position: "absolute",
			left: "0px",
			top: "50%",
			marginTop: "-20px"
		},
		callback: function() {
			if(!initDone) {
				return;
			}
			callback({
				stop: true
			});
		}
	});
	var nextBlocked = false;
	var nextButton = new UI.BarButton( {
		label: "Next Image",
		style: {
			position: "absolute",
			left: "100%",
			top: "50%",
			marginTop: "-20px",
			marginLeft: "-130px"
		},
		callback: function() {
			if(!initDone || nextBlocked) {
				return;
			}
			nextBlocked = true;
			setTimeout(function() {
				nextBlocked = false;
			}, 1000);
			timer.reset();
			showNextImage();
		}
	});
	var timer = new CountdownTimer({
		limit: timelimit * 60,
		paused: true,
		mode: "time",
		callback: function() {
			showNextImage();
		}
	});
	barWrapper.appendChild(stopButton.getDiv());
	barWrapper.appendChild(timer.getDiv());
	barWrapper.appendChild(nextButton.getDiv());
	barDiv.appendChild(barWrapper);
	
	
	var switchButton = document.createElement("div");
	switchButton.id = "switchButton";
	switchButton.title = "Switch Sides";
	switchButton.onclick = function() {
		lefty = !lefty;
		updateLeftRight();
		createCookie("lefty", lefty, 21);
	};
	contentDiv.appendChild(switchButton);
	
	function updateLeftRight() {
		if(lefty) {
			LIB.css(refOutput.getDiv(), {
				left: "600px"
			});
			LIB.css(drawingTools.getDiv(), {
				left: "0px"
			});
		} else {
			LIB.css(refOutput.getDiv(), {
				left: "0px"
			});
			LIB.css(drawingTools.getDiv(), {
				left: "600px"
			});
		}
	}
	updateLeftRight();
	
	this.setMode = function(p) {
		if(p !== mode) {
			mode = p;
			timer.setMode(mode);
			//put away current drawing and ref
		}
	};
	this.start = function() {
		paused = false;
		if(initDone) {
			timer.pause(false);
		}
	};
	this.stop = function() {
		timer.pause(true);
	};
	this.getContentDiv = function() {
		return contentDiv;
	};
	this.getBarDiv = function() {
		return barDiv;
	};
	this.setTimelimit = function(t) {
		console.log(t);
		t = parseFloat(t);
		console.log(t);
		if(t <= 0 || t > 1000) {
			return;
		}
		timelimit = t;
		timer.setTimelimit(t * 60);
		timer.reset();
		console.log("set limit");
	};
};

UI.StopScreen = function(p) {
	var barDiv = document.createElement("div");
	var contentDiv = document.createElement("div");
	barDiv.style.height = "100%";
	var barWrapper = document.createElement("div");
	barWrapper.id = "barCenterContainer";
	barDiv.appendChild(barWrapper);
	var data = p;
	var lefty = false;
	var currentEntry = -1;
	
	var continueButton = new UI.BarButton( {
		label: "Continue",
		style: {
			position: "absolute",
			left: "100%",
			top: "50%",
			marginTop: "-20px",
			marginLeft: "-130px"
		},
		callback: function() {
			p.callback({
				continueDrawing: true
			});
		}
	});
	var pageLabel = document.createElement("div");
	LIB.css(pageLabel, {
		color: "#fff",
		fontWeight: "bold",
		position: "absolute",
		left: "10%",
		top: "40%",
		width: "100px",
		textAlign: "center"
	});
	barWrapper.appendChild(pageLabel);
	barWrapper.appendChild(continueButton.getDiv());
	var prevButton = new UI.BarButton( {
		label: "<",
		title: "Previous Drawing",
		style: {
			position: "absolute",
			left: "0",
			top: "50%",
			marginTop: "-20px",
			width: "50px",
			display: "none"
		},
		callback: function() {
			currentEntry = Math.max(0, currentEntry - 1);
			update();
		}
	});
	barWrapper.appendChild(prevButton.getDiv());
	var nextButton = new UI.BarButton( {
		label: ">",
		title: "Next Drawing",
		style: {
			position: "absolute",
			left: "60%",
			top: "50%",
			marginTop: "-20px",
			marginLeft: "-130px",
			width: "50px",
			display: "none"
		},
		callback: function() {
			currentEntry = Math.min(data.length - 1, currentEntry + 1);
			update();
		}
	});
	barWrapper.appendChild(nextButton.getDiv());
	
	
	LIB.css(contentDiv, {
		color: "#777",
		textAlign: "center"
	});
	var initMessage = document.createElement("div");
	initMessage.innerHTML = "<br/><br/><br/><br/><b>You haven't finished any drawings yet.</b>";
	contentDiv.appendChild(initMessage);
	
	var ref = document.createElement("div");
	LIB.css(ref, {
		position: "absolute",
		left: 0,
		top: "40px",
		width: "500px",
		height: "500px",
		backgroundPosition: "center",
		backgroundSize: "cover",
		backgroundRepeat: "no-repeat"
	});
	var refLabel = document.createElement("div");
	refLabel.className = "refLabel";
	LIB.css(refLabel, {
		position: "absolute",
		left: "0px",
		top: "540px",
		width: "500px",
		paddingTop: "15px",
		textAlign: "center",
		backgroundColor: "#eee",
		height: "80px",
		color: "#888",
		display: "none"
	});
	var canvasWrapper = new Image();
	LIB.css(canvasWrapper, {
		position: "absolute",
		left: "0px",
		top: "40px",
		display: "none"
	});
	var canvasLabel = document.createElement("div");
	LIB.css(canvasLabel, {
		position: "absolute",
		left: "0px",
		top: "550px",
		width: "500px",
		display: "none"
	});
	canvasLabel.innerHTML = "Right-click/press-hold to save your drawing";
	
	var refWrapper = document.createElement("div");
	var drawingWrapper = document.createElement("div");
	LIB.css(refWrapper, {
		position: "absolute",
		top: 0,
		left: 0
	});
	LIB.css(drawingWrapper, {
		position: "absolute",
		top: 0,
		left: "600px"
	});
	contentDiv.appendChild(refWrapper);
	contentDiv.appendChild(drawingWrapper);
	
	refWrapper.appendChild(ref);
	refWrapper.appendChild(refLabel);
	drawingWrapper.appendChild(canvasWrapper);
	drawingWrapper.appendChild(canvasLabel);
	var saveCanvas = document.createElement("canvas");
	var saveButton, editButton, klekiRec;
	if(window.chrome) {
		var saveButton = new UI.BarButton( {
			label: "Save Drawing",
			style: {
				cssFloat: "left"
			},
			callback: function() {
				saveCanvas.width = 500;
				saveCanvas.height = 500;
				saveCanvas.getContext("2d").drawImage(canvasWrapper, 0, 0);
				saveCanvas.toBlob(function (blob) {
					window.saveAs(blob, "Doodler.png");
				}, "image/png");
			}
		});
		var editButton = new UI.BarButton( {
			label: "Keep On Drawing",
			style: {
				cssFloat: "right",
				width: "200px"
			},
			callback: function() {
				var data = "" + canvasWrapper.src;
				var intent = new WebKitIntent("http://webintents.org/edit", "image/png", data);
				var onSuccess = function(data) {
				};
				var onError = function(data) {
				};
				window.navigator.webkitStartActivity(intent, onSuccess, onError);
			}
		});
		/*klekiRec = document.createElement("div");
		klekiRec.innerHTML = "Kleki is highly recommended!";
		LIB.css(klekiRec, {
			position: "absolute",
			left: "330px",
			top: "45px",
			width: "100px",
			paddingLeft: "40px",
			textAlign: "left",
			backgroundImage: "url(kleki_logo.png)",
			backgroundRepeat: "no-repeat",
			fontSize: "15px",
			color: "#777",
		});*/
		canvasLabel.innerHTML = "";
		canvasLabel.appendChild(saveButton.getDiv());
		//canvasLabel.appendChild(editButton.getDiv()); //webintents not supported anymore
		//canvasLabel.appendChild(klekiRec);
	}
	
	
	function update() {
		pageLabel.innerHTML = (currentEntry + 1) + "/" + (data.length);
		ref.style.backgroundImage = "url(" + data[currentEntry].ref.imSrc + ")";
		if(data[currentEntry].ref.title === "" || !data[currentEntry].ref.title) {
			data[currentEntry].ref.title = "Untitled";
		}
		refLabel.innerHTML = '<i><a target="_blank" href="' + data[currentEntry].ref.link + '">' + data[currentEntry].ref.title + "</a></i><br/>by " + data[currentEntry].ref.owner;
		if(currentEntry === 0) {
			prevButton.getDiv().style.display = "none";
		} else {
			prevButton.getDiv().style.display = "block";
		}
		if(currentEntry === data.length - 1) {
			nextButton.getDiv().style.display = "none";
		} else {
			nextButton.getDiv().style.display = "block";
		}
		canvasWrapper.style.display = "block";
		canvasLabel.style.display = "block";
		refLabel.style.display = "block";
		canvasWrapper.src = data[currentEntry].drawing;
	}
	
	this.update = function(p) {
		var lefty = getCookie("lefty");
		if(lefty == ""){
			lefty = false;
		}
		if(lefty === "true") {
			refWrapper.style.left = "600px";
			drawingWrapper.style.left = 0;
		}
		if(lefty === "false") {
			refWrapper.style.left = 0;
			drawingWrapper.style.left = "600px";
		}
		
		data = p;
		if(data.length > 0) {
			if(initMessage) {
				contentDiv.removeChild(initMessage);
				initMessage = undefined;
			}
			currentEntry = data.length - 1;
			update();
		}
	};
	this.getBarDiv = function() {
		return barDiv;
	};
	this.getContentDiv = function() {
		return contentDiv;
	};
};

UI.IntroScreen = function(p) {
	var barDiv = document.createElement("div");
	var contentDiv = document.createElement("div");
	contentDiv.style.color = "#444";
	contentDiv.style.width = "400px";
	contentDiv.style.textAlign = "justify";
	contentDiv.style.marginLeft = "auto";
	contentDiv.style.marginRight = "auto";
	contentDiv.style.paddingTop = "20px";
	
	var startButton = document.createElement("div");
	startButton.className = "introStartButton";
	startButton.innerHTML = "Start Drawing";
	startButton.style.marginTop = "20px";
	var longtext = document.createElement("div");
	longtext.innerHTML = "Welcome to Doodler, a place where you can improve your drawing skills. Note that it's fairly important to use a pen-tablet or stylus for this web app.<br/><br/>";
	longtext.innerHTML += "You are tasked with replicating photos within 2 minutes each. Why that? We often tend to get lost in the details - things that don't really matter for the composition. Our creations and our productivity suffer as a result.<br/><br/>With the 2 minute time-limit you are forced to focus on the important aspects and make the most of every stroke. You will get more effective and efficient, plus you will study lots of interesting photos from Flickr!<br/><br/>";

	
	
	var timelimitLabel = document.createElement("span");
	timelimitLabel.innerHTML = "Timelimit (minutes): ";
	var timelimitInput = document.createElement("input");
	timelimitInput.value = 2;
	timelimitInput.style.width = "50px";
	timelimitInput.type = "number";
	timelimitInput.style.padding = "5px";
	
	contentDiv.appendChild(longtext);
	contentDiv.appendChild(timelimitLabel);
	contentDiv.appendChild(timelimitInput);
	contentDiv.appendChild(startButton);
	var im = new Image();
	LIB.css(im, {
		marginTop: "20px",
		marginLeft: "-150px"
	});
	im.src = "examples.jpg";
	contentDiv.appendChild(im);
	
	function startClick() {
		p.callback({
			start: true,
			timelimit: timelimitInput.value
		});
	}
	startButton.onmousedown = function() {
		startClick();
	};
	startButton.ontouchstart = function (event) {
		if (event.touches.length > 1) {
			return;
		}
		startClick();
	};
	
	
	
	
	this.getBarDiv = function() {
		return barDiv;
	};
	this.getContentDiv = function() {
		return contentDiv;
	};
};

var showTips = function(){};
var sendFeedback = function(){};

window.onload = function() {
	var bar = document.getElementById("topBar");
	var content = document.getElementById("contentArea");
	var logo = document.createElement("div");
	logo.id = "logoButtonIntro";
	LIB.css(logo, {
		transition: "left 1s ease-in-out"
	});
	bar.appendChild(logo);
	var drawingData = [];
	
	var drawing = false;
	
	var introScreen = new UI.IntroScreen({
		callback: function(val) {
			if(val.start) {
				if(val.timelimit) {
					drawingScreen.setTimelimit(val.timelimit);
				}
				
				
				bar.removeChild(introScreen.getBarDiv());
				content.removeChild(introScreen.getContentDiv());
				drawingScreen.getBarDiv().style.display = "block";
				drawingScreen.getContentDiv().style.display = "block";
				drawingScreen.getBarDiv().style.opacity = "0";
				drawingScreen.getContentDiv().style.opacity = "0";
				LIB.css(logo, {
					left: "36px"
				});
				setTimeout(function() {
					drawingScreen.getBarDiv().style.opacity = "1";
					drawingScreen.getContentDiv().style.opacity = "1";
				}, 200);
				setTimeout(function() {
					drawingScreen.getContentDiv().style.opacity = "1";
					drawingScreen.start();
					drawing = true;
					document.onmousedown = function() {
						return false;
					};
				}, 1000);
			}
		}
	});
	
	var drawingScreen = new UI.DrawingScreen({
		callback: function(val){
			if(val.nextImage) {
				drawingData.push(val.data);
				
			}
			if(val.stop) {
				document.onmousedown = function() {
					return true;
				};
				drawingScreen.stop();
				drawing = false;
				drawingScreen.getBarDiv().style.display = "none";
				drawingScreen.getContentDiv().style.display = "none";
				stopScreen.update(drawingData);
				stopScreen.getBarDiv().style.display = "block";
				stopScreen.getContentDiv().style.display = "block";
			}
			
		}
	});
	LIB.css(drawingScreen.getBarDiv(), {
		display: "none",
		transition: "opacity 0.8s ease-in"
	});
	LIB.css(drawingScreen.getContentDiv(), {
		display: "none",
		transition: "opacity 0.8s ease-in"
	});
	
	var stopScreen = new UI.StopScreen({
		callback: function(val) {
			if(val.continueDrawing) {
				document.onmousedown = function() {
					return false;
				};
				stopScreen.getBarDiv().style.display = "none";
				stopScreen.getContentDiv().style.display = "none";
				
				drawingScreen.getBarDiv().style.display = "block";
				drawingScreen.getContentDiv().style.display = "block";
				drawingScreen.start();
				drawing = true;
			}
		}
	});
	stopScreen.getBarDiv().style.display = "none";
	stopScreen.getContentDiv().style.display = "none";
	
	bar.appendChild(introScreen.getBarDiv());
	content.appendChild(introScreen.getContentDiv());
	bar.appendChild(drawingScreen.getBarDiv());
	content.appendChild(drawingScreen.getContentDiv());
	bar.appendChild(stopScreen.getBarDiv());
	content.appendChild(stopScreen.getContentDiv());
	
	sendFeedback = function() {
		//_gaq.push(['_trackEvent', 'Navigation', 'Closed', 'Infoscreen']);
		if(drawing) {
			drawingScreen.stop();
			document.onmousedown = function() {
				return true;
			};
		}
		var div = document.createElement("div");
		var descr = document.createElement("div");
		descr.style.textAlign = "justify";
		descr.innerHTML = "Send suggestions about Doodler. Problem reports, feature ideas and general comments are welcome.</br></br>";
		//INPUT FORM
		var closeFunc = function(){};
		var boxSize = 50;
		var inputDescription = document.createElement("textarea");
		inputDescription.placeholder = "Your feedback...";
		LIB.css(inputDescription, {
			fontSize: (boxSize / 4.0) + "px",
			resize: "none",
			border: "1px solid black",
			boxSizing: "border-box",
			boxShadow: "inset 0px 3px 8px rgba(0, 0, 0, 0.4)",
			width: "100%",
			height: "100%",
			padding: boxSize / 4.0 + "px",
			marginBottom: boxSize / 4.0 + "px"
		});
		inputDescription.onkeyup = function() {
			/*if(inputDescription.value != "") {
				send.disabled = false;
			} else {
				send.disabled = true;
			}*/
		};
		LIB.css(div, {
			fontSize: (boxSize / 3.0) + "px",
			position: "absolute",
			backgroundColor: "#fff",
			padding: "30px",
			color: "#555",
			width: (7 * boxSize) + "px",
			height: (7 * boxSize) + "px",
			top: "50%",
			marginTop: (-7 * boxSize / 2) + "px",
			borderRadius: "10px"
		});
		
		var inputWrapper = document.createElement("div");
		LIB.css(inputWrapper, {
			width: "100%",
			height: (boxSize * 4) + "px",
			paddingBottom: boxSize / 4.0 + "px",
			boxSizing: "border-box",
		});
		inputWrapper.appendChild(inputDescription);
		div.appendChild(descr);
		div.appendChild(inputWrapper);
		inputDescription.onclick = function() {
			inputDescription.focus();
		};
		
		var sendButton = new UI.BarButton( {
			label: "Send",
			style: {
				cssFloat: "right",
				marginTop: "23px"
			},
			callback: function() {
				sendFeedback(escape(inputDescription.value));
				closeFunc();
			}
		});
		var cancelButton = new UI.BarButton( {
			label: "Cancel",
			style: {
				cssFloat: "right",
				marginLeft: "10px",
				marginTop: "23px"
			},
			callback: function() {
				closeFunc();
			}
		});
		div.appendChild(cancelButton.getDiv());
		div.appendChild(sendButton.getDiv());
		
		function sendFeedback(msg) {
			var xmlhttp, response;
			xmlhttp = new XMLHttpRequest();
			xmlhttp.onreadystatechange = function() {
				var response;
				if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
					alert("Success. Thank you very much for your feedback.");
				}
			};
			xmlhttp.open("GET","sendFeedback.php?msg=" + msg,true);
			xmlhttp.send();
		}
		document.body.style.overflow = "hidden";
		UI.showPopup({
			target: document.body,
			div: div,
			setCallback: function(f) {
				closeFunc = f;
			},
			callback: function(val) {
				document.body.style.overflow = "";
				if(drawing) {
					document.onmousedown = function() {
						return false;
					};
					drawingScreen.start();
				}
			}
		});
	};
	setTimeout(function() {
		var script = document.createElement('script');
		script.src = "filesaver.js";
		document.getElementsByTagName('head')[0].appendChild(script);
	}, 1000);
};


var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-2041825-2']);
_gaq.push(['_trackPageview']);

(function() {
var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();
function updateAnalytics() {
	_gaq.push(['_trackEvent', 'Doodler', 'update', 'still_open']);
	setTimeout(updateAnalytics, 1000 * 60);
}
setTimeout(updateAnalytics, 1000 * 60);
</script>
</head>
<body>
<div id="main">
	<div id="topBarWrapper">
		<div id="topBar">
		</div>
	</div>
	<div id="contentArea">
	</div>
	<div id="footer">
		<div class="footerVertBlock"><button onclick="sendFeedback()">Send Feedback</button></div>
		<div class="footerVertBlock"><b>Doodler</b><br/>created by <a target="_blank" href="http://bitbof.com">bitbof</a><br><a target="_blank" href="changelog.txt">changelog</a></div>
		<div class="footerVertBlock"><b>More Art Apps</b><br/><a target="_blank" href="http://webchemy.org">Webchemy</a><br/><a target="_blank" href="http://kleki.com">Kleki</a><br/><a target="_blank" href="http://bitbof.com/experiments/">Experimental Tools</a></div>
	</div>
</div>
</body>
</html>
